{% extends 'base_dashboard.html' %}
{% block title %}‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô{% endblock %}
{% block content %}
{% include 'components/sidebar_dashboard.html' %}
{% include 'components/control-sidebar_dashboard.html' %}

<div class="content-wrapper" style="min-height: 1416px;">

    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">                          
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                        <ul class="flashes">
                            {% for category, message in messages %}
                            <script type="text/javascript">
                                document.addEventListener("DOMContentLoaded", function () {
                                    Swal.fire({
                                        title: "{{ message }}",
                                        icon: "{{ 'success' if category == 'success' else 'error' }}",
                                    });
                                });
                            </script>
                            {% endfor %}
                        </ul>
                        {% endif %}
                        {% endwith %}
                        <!-- /.card-header -->
                        <div class="card-body">
                            <table id="example1" class="table table-bordered table-striped table-sm">
                                <thead>
                                    <tr class="table-info">
                                        <th style="width: 1%">No.</th>
                                        <th style="width: 10%">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th style="width: 10%">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™</th>
                                        <th style="width: 10%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th style="width: 20%; text-align: center;">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥</th>
                                        <th style="width: 20%; text-align: center;">‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡∏π</th>
                                        <th style="width: 10%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
                                        <th style="width: 5%; text-align: center;">‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏ã‡∏≠‡∏£‡πå</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for enroll in enrollments %}
                                    <tr>
                                        <td align="center">{{ loop.index }}</td> 
                                        <td>
                                            {% for user in user_data %}
                                                {% if user[0] == enroll[1] %}
                                                    {{ user[1] }} {{ user[2] }}
                                                {% endif %}
                                            {% endfor %}
                                            <div class="progress">
                                                <div class="progress-bar{% if progress_data[enroll[1]]['progress_percentage'] == 100 %} completed{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ progress_data[enroll[1]]['progress_percentage'] }}%;" 
                                                    aria-valuenow="{{ progress_data[enroll[1]]['progress_percentage'] }}" aria-valuemin="0" aria-valuemax="100">
                                                    {% if progress_data[enroll[1]]['progress_percentage'] == 100 %}
                                                        Success
                                                    {% else %}
                                                        {{ progress_data[enroll[1]]['progress_percentage'] }}%
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>                                                                                
                                        <td>
                                            {% for course in course_data %}
                                                {% if course[0] == enroll[2] %}
                                                    {{ course[1] }}
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>{{ enroll[3] }}</td>
                                        <td>
                                            {% set progress = pending_data[(enroll[1], enroll[2])] %}
                                            {% if progress.pending_quizzes %}
                                                <ul>
                                                    {% for quiz in progress.pending_quizzes %}
                                                        <li>
                                                            ‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: {{ quiz[1] }} <br>
                                                            (‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {{ quiz[3] }})
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <div style="text-align: center;">
                                                    <button type="button" class="btn btn-success btn-sm"  style="border-radius: 100px;">‡∏ó‡∏≥‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>                                                  
                                                    </p>
                                                </div>                                              
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if progress.pending_videos %}
                                                <ul>
                                                    {% for video in progress.pending_videos %}
                                                        <li>
                                                            ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠: {{ video[1] }} <br>
                                                            (‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: {{ video[3] }})
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                            <div style="text-align: center;">
                                                <button type="button" class="btn btn-success btn-sm"  style="border-radius: 100px;">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>                                                  
                                                </p>
                                            </div> 
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if enroll[4] %}
                                                {{ enroll[4] }}
                                            {% else %}
                                                <div style="text-align: center;">
                                                    <button type="button" class="btn btn-danger btn-sm" style="border-radius: 100px;">
                                                        ‡∏¢‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </td>
                                        
                                        <td align="center">
                                            {% if not progress.pending_quizzes and not progress.pending_videos %}
                                            <a id="downloadCertificateBtn" 
                                                data-user-id="{{ enroll[1] }}" 
                                                data-enroll-id="{{ enroll[0] }}" 
                                                data-course-id="{{ enroll[2] }}" 
                                                class="btn btn-info btn-sm">
                                                <i class="fa fa-eye"></i>
                                            </a>                                     
                                            {% endif %}
                                        </td>                                    
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>

<!-- jQuery -->
<script src="/static/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables & Plugins -->
<script src="/static/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/static/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="/static/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="/static/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="/static/plugins/jszip/jszip.min.js"></script>
<script src="/static/plugins/pdfmake/pdfmake.min.js"></script>
<script src="/static/plugins/pdfmake/vfs_fonts.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="/static/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<!-- AdminLTE App -->
<script src="/static/dist/js/adminlte.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Page specific script -->
<script>
    $(function () {
      $("#example1").DataTable({
        "responsive": true,
        "lengthChange": true,
        "autoWidth": false,
        "buttons": [
          {
            extend: "copy",
            exportOptions: {
              columns: ':visible' // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ
            }
          },
          {
            extend: "csv",
            exportOptions: {
              columns: ':visible'
            }
          },
          {
            extend: "excel",
            exportOptions: {
              columns: ':visible'
            }
          },
          {
            extend: "print",
            exportOptions: {
              columns: ':visible' // ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ
            }
          },
          "colvis" // ‡∏õ‡∏∏‡πà‡∏° colvis ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
        ]
      }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
  
      $('#example2').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": false,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        "responsive": true,
      });
    });

    $(document).on('click', '#downloadCertificateBtn', function() {
        var userId = $(this).data('user-id');  // Get user_id of the user
        var enrollId = $(this).data('enroll-id');  // Get enroll_id
        var courseId = $(this).data('course-id');  // Get course_id
    
        if (!userId || !enrollId) {
            console.error('User ID or Enroll ID is not defined.');
            return;
        }
        
        const certificateUrl = `/generate_certificate?user_id=${userId}&enroll_id=${enrollId}`;
        // Send request to the server to generate the certificate
        
        Swal.fire({
            text: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß!',
            iconHtml: `<div>üéì</div>`,
            html: `<p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</p>
                    <a href="${certificateUrl}" download="certificate.png">
                        <img src="${certificateUrl}" alt="Certificate" style="width:100%;max-width:1400px;"/>
                    </a>
                    <div class="d-flex justify-content-end mt-4">
                        <a href="${certificateUrl}" download="certificate.png" class="btn btn-success mx-2 btn-sm">
                            ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£
                        </a>
                        <a href="/enroll_table/${courseId}" class="btn btn-secondary mx-2 btn-sm" data-dismiss="modal">
                            ‡∏õ‡∏¥‡∏î
                        </a>
                    </div>`,
            showConfirmButton: false,
            width: '700px'
        });
    });
    
</script>

<style>
    .progress-bar {
        background-color: #007bff; /* ‡∏™‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
        transition: background-color 0.3s ease;
        color: white; /* ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
        text-align: center; /* ‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á */
    }
    
    .progress-bar.completed {
        background-color: green; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á 100% */
    }
    
</style>
{% include 'components/footer_dashboard.html' %}
{% endblock %}
